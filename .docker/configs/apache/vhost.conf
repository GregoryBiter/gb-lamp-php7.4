# Глобальная директива ServerName для подавления предупреждения
ServerName ${VHOST_SERVER_NAME}

# Настройки производительности Apache
KeepAlive On
MaxKeepAliveRequests 100
KeepAliveTimeout 5

# Сжатие контента
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
</IfModule>

<VirtualHost *:80>
    ServerName ${VHOST_SERVER_NAME}
    ServerAlias ${VHOST_SERVER_ALIAS}
    DocumentRoot ${VHOST_DOCUMENT_ROOT}

    DirectoryIndex index.php index.html

    <Directory ${VHOST_DOCUMENT_ROOT}>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
        
        # Настройки для OpenCart
        <IfModule mod_rewrite.c>
            RewriteEngine On
            
            # Правила для OpenCart (если используется)
            RewriteBase /
            RewriteRule ^sitemap.xml$ index.php?route=extension/feed/google_sitemap [L]
            RewriteRule ^googlebase.xml$ index.php?route=extension/feed/google_base [L]
            RewriteRule ^system/storage/(.*) index.php?route=error/not_found [L]
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteCond %{REQUEST_URI} !.*\.(ico|gif|jpg|jpeg|png|js|css)
            RewriteRule ^([^?]*) index.php?_route_=$1 [L,QSA]
        </IfModule>
    </Directory>

    # Разрешить статические файлы и установить правильные Content-Type
    <FilesMatch "\.(css|js|jpe?g|png|gif|ico|svg|woff|woff2|ttf|eot|webp)$">
        # Отключить выполнение PHP для статических файлов
        SetHandler default-handler
        
        # Установка MIME типов
        <IfModule mod_mime.c>
            AddType application/javascript .js
            AddType text/css .css
            AddType image/svg+xml .svg
            AddType application/font-woff .woff
            AddType application/font-woff2 .woff2
            AddType application/vnd.ms-fontobject .eot
            AddType application/x-font-ttf .ttf
            AddType image/webp .webp
        </IfModule>
        
        # Кэширование для статических файлов (только для production)
        <IfModule mod_expires.c>
            ExpiresActive Off
            # Для production раскомментируйте следующие строки:
            # ExpiresActive On
            # ExpiresByType text/css "access plus 1 month"
            # ExpiresByType application/javascript "access plus 1 month"
            # ExpiresByType image/png "access plus 1 month"
            # ExpiresByType image/jpg "access plus 1 month"
            # ExpiresByType image/jpeg "access plus 1 month"
            # ExpiresByType image/gif "access plus 1 month"
            # ExpiresByType image/ico "access plus 1 month"
        </IfModule>
    </FilesMatch>
    
    # Отключение кэширования для среды разработки
    <IfModule mod_headers.c>
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
        
        # Безопасность
        Header always set X-Content-Type-Options nosniff
        Header always set X-Frame-Options DENY
        Header always set X-XSS-Protection "1; mode=block"
        Header always set Referrer-Policy "strict-origin-when-cross-origin"
    </IfModule>
    
    # Безопасность - скрытие версии PHP
    <IfModule mod_headers.c>
        Header unset X-Powered-By
    </IfModule>
    
    # Запрет доступа к служебным файлам
    <FilesMatch "^\.">
        Require all denied
    </FilesMatch>
    
    <FilesMatch "\.(htaccess|htpasswd|ini|log|sh|inc|conf)$">
        Require all denied
    </FilesMatch>
    
    ErrorLog ${APACHE_LOG_DIR}/${VHOST_SERVER_NAME}.error.log
    CustomLog ${APACHE_LOG_DIR}/${VHOST_SERVER_NAME}.access.log combined
</VirtualHost>